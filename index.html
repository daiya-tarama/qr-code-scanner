<!DOCTYPE html>
<html>
  <head>
    <title>QRコード読み取り</title>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
      function onScanSuccess(decodedText, decodedResult) {
        // QRコードの内容を取得
        const qrCode = decodedText;

        // Google Apps Script の Web アプリ URL
        const scriptUrl = "https://script.google.com/macros/s/AKfycby0tzVkKnPF4uLDT4PLvxQWzj_Gwkj2w1OYhlG_md8M830dRnZkI9Ai_N333IW9G319/exec?qrCode=" + encodeURIComponent(qrCode);

        // サーバーにリクエスト送信
        fetch(scriptUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTPエラー: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            // サーバーからのレスポンスを画面に表示
            const feedbackDiv = document.getElementById("feedback");
            feedbackDiv.innerText = data.message; // サーバーからのメッセージを表示

            // フィードバックを3秒後にクリア
            setTimeout(() => {
              feedbackDiv.innerText = ""; // フィードバックをクリア
            }, 3000);
          })
          .catch(error => {
            console.error("エラー:", error);

            // エラー時のフィードバックを表示
            const feedbackDiv = document.getElementById("feedback");
            feedbackDiv.innerText = "サーバーへのリクエストに失敗しました";
            setTimeout(() => {
              feedbackDiv.innerText = ""; // フィードバックをクリア
            }, 3000);
          });
      }

      function onScanFailure(error) {
        // QRコード読み取り失敗時（エラーをコンソールに表示）
        console.warn("QRコード読み取りエラー:", error);
      }

      window.onload = function () {
        // QRコード読み取り機能の初期化
        const html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start(
          { facingMode: "environment" }, // 背面カメラ
          { fps: 10, qrbox: 250 }, // スキャン速度とエリア
          onScanSuccess,
          onScanFailure
        );
      };
    </script>
    <style>
      #feedback {
        margin-top: 20px;
        font-size: 18px;
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>QRコード読み取り</h1>
    <div id="qr-reader" style="width: 300px; height: 300px;"></div>
    <div id="feedback"></div> <!-- フィードバック表示用の領域 -->
  </body>
</html>