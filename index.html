<!DOCTYPE html>
<html>
  <head>
    <title>QRコード読み取り</title>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
      let lastScannedCode = null; // 最後にスキャンしたQRコードを保存

      function onScanSuccess(decodedText, decodedResult) {
        // QRコードの内容を取得
        if (decodedText === lastScannedCode) {
          // 前回と同じQRコードの場合は処理をスキップ
          return;
        }

        lastScannedCode = decodedText; // 現在のQRコードを保存

        const qrCode = decodedText;

        // Google Apps Script の Web アプリ URL
        const scriptUrl =
          "https://script.google.com/macros/s/AKfycby0tzVkKnPF4uLDT4PLvxQWzj_Gwkj2w1OYhlG_md8M830dRnZkI9Ai_N333IW9G319/exec?=" +
          encodeURIComponent(qrCode);

        // サーバーにリクエスト送信
        fetch(scriptUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTPエラー: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            // サーバーからのレスポンスを画面に表示
            const feedbackDiv = document.getElementById("feedback");
            feedbackDiv.innerText = data.message; // サーバーからのメッセージを表示
            feedbackDiv.style.display = "block"; // 表示する

            // フィードバックを3秒後にクリア
            setTimeout(() => {
              feedbackDiv.innerText = ""; // フィードバックをクリア
              feedbackDiv.style.display = "none"; // 非表示にする
              lastScannedCode = null; // 再スキャン可能にする
            }, 3000);
          })
          .catch((error) => {
            console.error("エラー:", error);

            // エラー時のフィードバックを表示
            const feedbackDiv = document.getElementById("feedback");
            feedbackDiv.innerText = "サーバーへのリクエストに失敗しました";
            feedbackDiv.style.display = "block"; // 表示する
            setTimeout(() => {
              feedbackDiv.innerText = ""; // フィードバックをクリア
              feedbackDiv.style.display = "none"; // 非表示にする
              lastScannedCode = null; // 再スキャン可能にする
            }, 3000);
          });
      }

      function onScanFailure(error) {
        // QRコード読み取り失敗時（エラーをコンソールに表示）
        console.warn("QRコード読み取りエラー:", error);
      }

      window.onload = function () {
        // QRコード読み取り機能の初期化
        const html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start(
          { facingMode: "environment" }, // 背面カメラ
          { fps: 10, qrbox: 250 }, // スキャン速度とエリア
          onScanSuccess,
          onScanFailure
        );
      };
    </script>
    <style>
      #feedback {
        position: fixed; /* 固定位置 */
        bottom: 10%; /* 画面下部に配置 */
        left: 50%; /* 中央寄せ */
        transform: translateX(-50%); /* 中央に配置 */
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.7); /* 半透明の背景 */
        color: white; /* テキストの色を白に */
        font-size: 18px;
        border-radius: 5px;
        display: none; /* 初期状態は非表示 */
        text-align: center;
        z-index: 1000; /* 前面に表示 */
      }

      #qr-reader {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>QRコード読み取り</h1>
    <div id="qr-reader" style="width: 300px; height: 300px;"></div>
    <div id="feedback"></div> <!-- フィードバック表示用の領域 -->
  </body>
</html>